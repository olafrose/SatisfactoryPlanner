<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SatisfactoryPlanner.Avalonia.ViewModels"
             xmlns:ap="using:SatisfactoryPlanner.Avalonia.AttachedProperties"
             x:Class="SatisfactoryPlanner.Avalonia.Views.ProductionPlannerView"
             x:DataType="vm:ProductionPlannerViewModel">

  <Grid>
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="*" MinWidth="300"/>
      <ColumnDefinition Width="Auto"/>
      <ColumnDefinition Width="350" MaxWidth="400"/>
    </Grid.ColumnDefinitions>

    <!-- Left Panel - Production Tree -->
    <Border Grid.Column="0"
            Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
            BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
            BorderThickness="0,0,1,0">
      
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                BorderThickness="0,0,0,1"
                Padding="16,12">
          <TextBlock Text="Production Chain"
                     FontWeight="SemiBold"
                     FontSize="14"/>
        </Border>
        
        <!-- Production Flow Graph -->
        <Grid Grid.Row="1">
          <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
            <Grid Margin="20">
              
              <!-- Connection Lines (behind nodes) -->
              <ItemsControl ItemsSource="{Binding ConnectionLines}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <Canvas Background="#FAFAFA" MinWidth="800" MinHeight="600"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Path Stroke="#1976D2" 
                          StrokeThickness="2" 
                          Data="{Binding PathData}"
                          StrokeLineCap="Round"
                          IsHitTestVisible="False">
                      <Path.Effect>
                        <DropShadowEffect Color="#40000000" BlurRadius="2" OffsetX="1" OffsetY="1"/>
                      </Path.Effect>
                    </Path>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              
              <!-- Production Nodes (on top of lines) -->
              <ItemsControl ItemsSource="{Binding ProductionNodes}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <Canvas Background="Transparent" MinWidth="800" MinHeight="600"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
              
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border Background="#E3F2FD"
                          BorderBrush="#1976D2"
                          BorderThickness="2"
                          CornerRadius="8"
                          Padding="12"
                          MinWidth="160"
                          BoxShadow="0 2 8 0 #20000000"
                          Name="ProductionNodeBorder"
                          ap:DragHelper.IsDraggable="True">
                    <Border.RenderTransform>
                      <TranslateTransform X="{Binding XPosition}" Y="{Binding YPosition}"/>
                    </Border.RenderTransform>
                    
                    <StackPanel IsHitTestVisible="False">
                      <TextBlock Text="{Binding Name}"
                                 FontWeight="Bold"
                                 FontSize="14"
                                 HorizontalAlignment="Center"
                                 Foreground="#1565C0"
                                 IsHitTestVisible="False"/>
                      <TextBlock Text="{Binding BuildingName}"
                                 FontSize="12"
                                 HorizontalAlignment="Center"
                                 Margin="0,4,0,0"
                                 Foreground="#424242"
                                 IsHitTestVisible="False"/>
                      <TextBlock FontSize="11"
                                 HorizontalAlignment="Center"
                                 Margin="0,2,0,0"
                                 Foreground="#666666"
                                 IsHitTestVisible="False">
                        <TextBlock.Text>
                          <MultiBinding StringFormat="{}{0:F1}x {1:F1}/min">
                            <Binding Path="BuildingCount"/>
                            <Binding Path="ProductionRate"/>
                          </MultiBinding>
                        </TextBlock.Text>
                      </TextBlock>
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
              </ItemsControl>
              
            </Grid>
          </ScrollViewer>
        </Grid>
      </Grid>
    </Border>

    <!-- Splitter -->
    <GridSplitter Grid.Column="1"
                  Width="4"
                  Background="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                  HorizontalAlignment="Center"/>

    <!-- Right Panel - Product Selection -->
    <Border Grid.Column="2"
            Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
            IsVisible="{Binding IsProductSelectionPanelOpen}">
      
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                BorderThickness="0,0,0,1"
                Padding="16,12">
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <TextBlock Grid.Column="0"
                       Text="Production Targets"
                       FontWeight="SemiBold"
                       FontSize="14"
                       VerticalAlignment="Center"/>
            
            <!-- Minimize button -->
            <Button Grid.Column="1"
                    Background="Transparent"
                    BorderThickness="0"
                    Padding="4"
                    VerticalAlignment="Center">
              <Path Data="M6 19h12v2H6z" 
                    Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                    Width="14" Height="14"/>
            </Button>
          </Grid>
        </Border>
        
        <!-- Target list -->
        <ScrollViewer Grid.Row="1"
                      Padding="16">
          
          <ItemsControl ItemsSource="{Binding ProductionTargets}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="12"
                        Margin="0,0,0,8">
                  
                  <Grid>
                    <Grid.RowDefinitions>
                      <RowDefinition Height="Auto"/>
                      <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*"/>
                      <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Main content -->
                    <StackPanel Grid.Row="0" Grid.Column="0" Grid.RowSpan="2">
                      
                      <!-- Product selection -->
                      <ComboBox SelectedItem="{Binding TargetItem}"
                                ItemsSource="{Binding $parent[UserControl].DataContext.AvailableItems}"
                                Margin="0,0,0,8"
                                HorizontalAlignment="Stretch">
                        <ComboBox.ItemTemplate>
                          <DataTemplate>
                            <TextBlock Text="{Binding Name}"/>
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>
                      
                      <!-- Rate input -->
                      <Grid>
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="*"/>
                          <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <NumericUpDown Grid.Column="0"
                                       Value="{Binding TargetRate}"
                                       Minimum="0"
                                       Maximum="9999"
                                       Increment="10"
                                       FormatString="F1"/>
                        
                        <TextBlock Grid.Column="1"
                                   Text="/min"
                                   VerticalAlignment="Center"
                                   Margin="8,0,0,0"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
                      </Grid>
                    </StackPanel>
                    
                    <!-- Remove button -->
                    <Button Grid.Row="0" Grid.Column="1"
                            Command="{Binding RemoveCommand}"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="8"
                            VerticalAlignment="Top"
                            HorizontalAlignment="Right"
                            ToolTip.Tip="Remove target">
                      <Path Data="M6 6L18 18M6 18L18 6"
                            Stroke="Red"
                            StrokeThickness="2"
                            Width="12" Height="12"/>
                    </Button>
                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
        
        <!-- Add target button -->
        <Border Grid.Row="2"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
                BorderThickness="0,1,0,0"
                Padding="16">
          <StackPanel Spacing="8">
            <Button Content="+ Add Production Target"
                    Command="{Binding AddProductionTargetCommand}"
                    HorizontalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    Padding="12"/>
                  
            <!-- Status display -->
            <TextBlock Text="{Binding CalculationStatus}"
                       HorizontalAlignment="Center"
                       FontSize="12"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       TextWrapping="Wrap"/>
          </StackPanel>
        </Border>

      </Grid>
    </Border>
  </Grid>

  <UserControl.Styles>
    <!-- Hover effects for draggable production nodes -->
    <Style Selector="Border[Name=ProductionNodeBorder]:pointerover">
      <Setter Property="BorderBrush" Value="#0D47A1"/>
      <Setter Property="BoxShadow" Value="0 4 12 0 #30000000"/>
      <Setter Property="Cursor" Value="Hand"/>
    </Style>
    
    <!-- Active drag state -->
    <Style Selector="Border[Name=ProductionNodeBorder]:pressed">
      <Setter Property="BorderBrush" Value="#1976D2"/>
      <Setter Property="BoxShadow" Value="0 6 16 0 #40000000"/>
      <Setter Property="Background" Value="#E8F4FD"/>
    </Style>
  </UserControl.Styles>
</UserControl>